{{extend 'plantilla.html'}}
{{block head}}
    <style>
        .dropdown-item:focus, .dropdown-item:hover{
            background-color: #c5d6e6;
        }
    </style>
{{end}}
        <h3 class="encabezado">Áreas</h3>
<table id="example" class="display" width="100%" cellspacing="0">
        <thead>
            <tr>
                <!--<th>Id</th>-->
                <th>Nombre</th>
                <th>Tipo de área</th>
                <th>Descripción</th>
                <th>Opciones</th>
            </tr>
        </thead>
        <tbody>
            {{for area in areas:}}
                <tr>
                    <td>{{=area.name if area.name else '-'}}</td>
                    <td>{{=area.id_area_type.name if area.id_area_type.name else '-'}}</td>
                    <td>{{=area.description if area.description else '-'}}</td>
                    <td>
                        <a title="Ubicación" class="botones-iconos btn btn-info btn-rounded btn-icon" style="padding: 9px 14px !important;" href={{=URL('map','ubicacion_area',args=area.id)}}>
                            <i class="fa fa-map-marker"></i>
                        </a>
                        <a title="Editar" class="botones-iconos btn btn-info btn-rounded btn-icon" style="color:white; background-color: #05e20c;" onclick="editar()"}}>
                            <i class="fa fa-pencil"></i>
                        </a>
                        <a title="Eliminar" class="botones-iconos btn btn-info btn-rounded btn-icon" style="background-color: #f84a4a;" href="#" onclick="eliminar('{{=area.id}}')">
                            <i class="fa fa-trash"></i>
                        </a>
                        <div class="dropdown show" style="display: inline;">
                          <a title="Información" class="botones-iconos btn btn-info btn-rounded btn-icon dropdown-toggle" style="background-color: #0062cc;" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-info"></i>
                          </a>
                          <div class="dropdown-menu" aria-labelledby="dropdownMenuLink" style="font-size: .5rem;">
                            <a class="dropdown-item" href={{=URL('pluviometer','pluv_by_area',args=area.id)}} >Pluviometros</a>
                            <a class="dropdown-item" href={{=URL('precipitation_concentration_index','to_show_ci_for_selected_area',args=area.id)}}>Índice de concentracion</a>
                            <a class="dropdown-item" href={{=URL('precipitation_concentration_index','to_show_ci_for_selected_area_by_month',args=area.id)}}>Índice de concentracion por mes</a>
                          </div>
                        </div>
                    </td>
                </tr>
            {{pass}}
        </tbody>
</table>

{{block body_end}}
    <div id="edit_area_modal" class="modal fade">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content" style="width: 400px">
                                <div class="modal-header">
                                    <h5 class="modal-title">Crear área</h5>
                                    <button type="button" class="close xButton"><span>&times;</span></button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="name">Nombre:</label>
                                        <input type="text" class="form-control" id="name">
                                        <div id="name-error-box"></div>
                                    </div>
                                    <label for="area_type_select">Tipo de área:</label>
                                    <select class="form-control" id="area_type_select" style="padding-bottom: 10px;padding-top: 8px;">
                                        {{for a_type in area_types:}}
                                            <option value={{=a_type.id}}>{{=a_type.name}}</option>
                                        {{pass}}
                                    </select>
                                    <div class="form-group">
                                        <label for="description">Descripción:</label>
                                        <textarea type="text" class="form-control" id="description" rows="3"></textarea>
                                        <div id="description-error-box"></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button id="closeButton" type="button" class="btn btn-danger">Cerrar</button>
                                    <button id="acceptButton" type="button" class="btn btn-success">Aceptar</button>
                                </div>
                            </div>
                        </div>
                    </div>
        
{{end body_end}}

<script>
{{block datatable}}
    let table = data_table.DataTable();

    function eliminar(id) {
        swal({
            title: "¿Está seguro de eliminar?",
            text: "El area será eliminada completamente del sistema.",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "Eliminar",
            cancelButtonText: "Cancelar",
            closeOnConfirm: true,
            closeOnCancel: true
        },
            function (isConfirm) {
                if (isConfirm) {
                    let url = "{{=URL('area','remove_area')}}";
                    location.href = url + "/" + id;
                }
            });
    }

    //Events listeners to close modal
    $('#edit_area_modal #closeButton').off().on('click', () => {
                $("#edit_area_modal").modal('toggle');
        })

    $('#edit_area_modal .xButton').off().on('click', () => {
            $("#edit_area_modal").modal('toggle');
    })

    // Event listener on accept button modal
    $('#edit_area_modal #acceptButton').off().on('click', () => {
            let name = $('#edit_area_modal #name').val().trim();

            // Validations
            if (name.length === 0) {
                // if name input is empty
                showMyNotification('error', "Existen errores en el formulario");
                showErrorDiv($("#name-error-box"), "Este campo no puede estar vacío")
            } else {
                $("#edit_area_modal").modal('toggle');

                let description = $("#edit_area_modal #description").val().trim();
                let area_type_id = $("#edit_area_modal #area_type_select option:selected").val();

                $(".loading-spinner").show(); // Show loading

                // request to edit_area_api
                axios.post('{{=URL('area', 'edit_area_api')}}', {
                    name: name,
                    description: description,
                    area_type_id: area_type_id,
                    edit_type: 'information'
                })
                .then(response => {
                    showMyNotification('success', "El área se ha creado correctamente");
                    $(".loading-spinner").hide(); // Hide loading
                    table.destroy(); //Destroiyng datatable for refetch
                    table = data_table.DataTable(); //Building datatable again with updated data
                })
                .catch(error => {
                    showMyNotification('error', "Hubo errores en el servidor");
                    $(".loading-spinner").hide(); // Hide loading
                });
            }

    })

    function editar(){
        //Function to open edit pluviometer modal and prefill the form
        $("#edit_area_modal").modal({backdrop: "static"});// open modal
        // console.log()
        //Prepopulate form with pluv information
        // $('#edit_area_modal #name').val(row.name);
        // $('#edit_area_modal #station_name').val(row.station_name);
        // $('#edit_area_modal #msnm').val(row.msnm);
        // $('#edit_area_modal #id_pluviometer_type').val(row.id_pluviometer_type);
    }
{{end datatable}}

</script>



